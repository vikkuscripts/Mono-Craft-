<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta charset="utf-8">
    <title>Update Payment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <style>
        body {
            background-color: #f7f7f7;
            font-size: 14px;
        }

        .app-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 15px;
        }

        .card {
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        .card-header {
            background: #007bff;
            color: white;
            font-weight: 600;
            border-radius: 6px 6px 0 0 !important;
        }

        /* overlay + popup */
        #overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            z-index: 999;
        }

        .overlay-inner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: transparent;
        }

        .spinner {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.25);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .popup-card {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            transform: translateX(-50%);
            top: 22%;
            min-width: 260px;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .popup-card.success {
            background: #0b8a3a;
        }

        .popup-card.error {
            background: #b30000;
        }

        .info-label {
            font-size: 0.85rem;
            color: #6c757d;
            display: block;
            margin-bottom: 2px;
        }

        .info-val {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .info-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #e9ecef;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <div class="card">
            <div class="card-header text-center">
                Payment Collection
            </div>
            <div class="card-body">

                <!-- Search Section -->
                <div class="form-group row justify-content-center">
                    <div class="col-md-6">
                        <label>Find Order (Reference Code)</label>
                        <div class="input-group">
                            <input type="text" id="refSearch" class="form-control"
                                placeholder="Enter Ref Code (e.g. R10045)">
                            <div class="input-group-append">
                                <button class="btn btn-primary" onclick="searchOrder()">Search</button>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <!-- Info Section (Hidden By Default) -->
                <div id="orderInfo" style="display:none;">

                    <!-- Row 1: Order Info -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-2">
                            <div class="info-box">
                                <span class="info-label">Customer</span>
                                <span class="info-val" id="disp_customer">--</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="info-box">
                                <span class="info-label">Order Date</span>
                                <span class="info-val" id="disp_date">--</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="info-box">
                                <span class="info-label">Grand Total</span>
                                <span class="info-val" id="disp_total">--</span>
                            </div>
                        </div>
                        <div class="col-md-3 mb-2">
                            <div class="info-box">
                                <span class="info-label">Advance Amount</span>
                                <span class="info-val" id="disp_advance">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Balance & Status -->
                    <div class="alert alert-warning text-center">
                        Balance Due: <strong id="disp_balance" style="font-size:1.2rem;">--</strong>
                    </div>

                    <!-- Payment History Table (Moved Up) -->
                    <div id="historySection" class="mt-4 mb-4" style="display:none;">
                        <h5 class="text-secondary d-flex justify-content-between align-items-center">
                            <span>Payment History</span>
                            <span class="badge badge-success px-3 py-2" style="font-size: 0.9rem;">
                                Already Paid: <span id="hist_total_paid">--</span>
                            </span>
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm text-center bg-white">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Payment Type</th>
                                        <th>Payment Amount</th>
                                        <th>Remarks</th>
                                        <th>Payment Date</th>
                                        <th>Document Upload</th>
                                        <th>Invoice</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody">
                                    <!-- JS Populated -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <hr>
                    <h5 class="mb-3 text-secondary">New Payment Details</h5>

                    <!-- Row 2: Payment Inputs -->
                    <div class="row">
                        <!-- Payment Type -->
                        <div class="col-md-3 form-group">
                            <label>Payment Type</label>
                            <select id="payType" class="form-control">
                                <option value="Cash">Cash</option>
                                <option value="UPI">UPI / Online</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <!-- Payment Amount -->
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>Payment Amount (₹)</label>
                                <input type="number" id="payAmount" class="form-control" placeholder="0.00">
                            </div>
                        </div>

                        <!-- Payment Date -->
                        <div class="col-md-3 form-group">
                            <label>Payment Date</label>
                            <input type="date" id="payDate" class="form-control">
                        </div>

                        <!-- Document Upload -->
                        <div class="col-md-3 form-group">
                            <label>Document Upload</label>
                            <input type="file" id="payFile" class="form-control-file" accept="image/*,.pdf">
                            <small class="text-muted">Max 5MB</small>
                        </div>
                    </div>

                    <!-- Submit & Remarks Split -->
                    <div class="row mt-3">
                        <div class="col-md-6 form-group">
                            <textarea id="payRemarks" class="form-control" rows="2"
                                placeholder="Enter remarks (optional)"></textarea>
                        </div>
                        <div class="col-md-6 form-group d-flex align-items-center">
                            <button class="btn btn-success btn-lg btn-block h-100" onclick="submitPayment()">
                                Save Payment & Regenerate PDF
                            </button>
                        </div>
                    </div>


                </div>
            </div>
        </div>

        <!-- overlay + popup -->
        <div id="overlay" aria-hidden="true">
            <div class="overlay-inner" role="status" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <div style="color:white; font-weight:600">Processing...</div>
            </div>
        </div>

        <div id="popup-success" class="popup-card success" role="alert">
            <div style="font-size:30px;">✔</div>
            <div id="popup-success-text">Saved successfully</div>
            <div style="margin-top:12px;">
                <a id="newPdfLink" href="#" target="_blank" class="btn btn-light btn-sm" style="display:none">View New
                    PDF</a>
                <button class="btn btn-light btn-sm ml-2" onclick="hidePopup()">Close</button>
            </div>
        </div>

        <div id="popup-error" class="popup-card error" role="alert">
            <div style="font-size:30px;">✖</div>
            <div id="popup-error-text">Error message</div>
            <div style="margin-top:12px;">
                <button class="btn btn-light btn-sm" onclick="hidePopup()">Close</button>
            </div>
        </div>

        <!-- JS -->
        <script>
            let currentRefCode = null;
            let popupTimeout;

            // Set default date to today
            document.getElementById("payDate").valueAsDate = new Date();

            function showOverlay() { document.getElementById("overlay").style.display = "flex"; }
            function hideOverlay() { document.getElementById("overlay").style.display = "none"; }

            function showPopup(type, msg, url) {
                hidePopup();
                const id = type === "error" ? "popup-error" : "popup-success";
                const txt = type === "error" ? "popup-error-text" : "popup-success-text";
                document.getElementById(id).style.display = "block";
                document.getElementById(txt).textContent = msg;

                if (type === "success" && url) {
                    const btn = document.getElementById("newPdfLink");
                    btn.href = url;
                    btn.style.display = "inline-block";
                }
            }

            function hidePopup() {
                document.getElementById("popup-success").style.display = "none";
                document.getElementById("popup-error").style.display = "none";
            }

            function searchOrder() {
                const ref = document.getElementById("refSearch").value.trim();
                if (!ref) return;

                showOverlay();
                google.script.run
                    .withSuccessHandler(renderOrder)
                    .withFailureHandler(err => {
                        hideOverlay();
                        showPopup("error", "Failed: " + err.message);
                    })
                    .getOrdersByRefCode(ref);
            }

            function renderOrder(data) {
                hideOverlay();
                if (!data || data.error || (Array.isArray(data) && data.length === 0)) {
                    showPopup("error", "Order not found");
                    document.getElementById("orderInfo").style.display = "none";
                    return;
                }

                let header, totals, history;
                if (data.header) {
                    header = data.header;
                    totals = data.totals;
                    history = data.history || [];
                } else if (Array.isArray(data) && data.length > 0) {
                    header = data[0];
                    totals = {
                        GrandTotal: Number(header["Footer Grand Total"] || header["GrandTotal"] || 0),
                        AdvanceAmount: Number(header["AdvanceAmount"] || 0)
                    };
                    history = [];
                } else {
                    showPopup("error", "Invalid data structure");
                    return;
                }

                document.getElementById("orderInfo").style.display = "block";
                currentRefCode = header["RefCode"];

                setText("disp_customer", header["CustomerName"] || header["Person Name"] || header["customerName"]);
                setText("disp_date", formatDate(header["OrderDate"]));

                const gTotal = Number(totals.GrandTotal || 0);
                const baseAdv = Number(totals.AdvanceAmount || 0); // Raw Sheet Value
                const collSum = Number(totals.CollectionSum || 0);
                const totalPaid = baseAdv + collSum;
                const due = gTotal - totalPaid;

                setText("disp_total", "₹ " + gTotal.toFixed(2));
                setText("disp_advance", "₹ " + baseAdv.toFixed(2)); // Shows sheet Advance Amount
                setText("disp_balance", "₹ " + due.toFixed(2));

                // Set Already Paid labels
                const totalPaidStr = "₹ " + totalPaid.toFixed(2);
                setText("hist_total_paid", totalPaidStr);

                // Render History
                const tbody = document.getElementById("historyTableBody");
                const histSec = document.getElementById("historySection");
                tbody.innerHTML = "";

                // Move History Table ABOVE Inputs ("already paid will show upper side of table" ? No, "already paid will show... up side of the colm Payment Amount")
                // The user said: "already paid will show upper side of table... up side of the colm Payment Amount"
                // AND "already paid will be replaced by the advance amount from sales order" ?
                // Conflicting?
                // "already paid will be replaced by the advance amount from sales order"
                // AND "grand total - already paid = due"
                // If GT - AlreadyPaid = Due, then AlreadyPaid MUST be TotalPaid.
                // But if AlreadyPaid = AdvanceAmount(Sheet), and Sheet isn't updated, then Due is wrong.
                // Unless the user WANTS it to be wrong or expects Sheet to be updated? 
                // In Step 133 they said "do not update the advance amount".
                // So TotalPaid is the only correct way to get Due.

                // Let's assume "Already Paid" label implies Total Paid (Base+History).

                if (history.length > 0) {
                    histSec.style.display = "block";
                    history.forEach(h => {
                        const tr = document.createElement("tr");
                        const docLink = h.doc && h.doc.startsWith("http") ? `<a href="${h.doc}" target="_blank">View</a>` : "-";
                        const invLink = h.invoice && h.invoice.startsWith("http") ? `<a href="${h.invoice}" target="_blank">PDF</a>` : "-";

                        tr.innerHTML = `
                      <td>${h.type || "-"}</td>
                      <td class="font-weight-bold text-success">₹${Number(h.amount).toFixed(2)}</td>
                      <td>${h.remarks || "-"}</td>
                      <td>${formatDate(h.date)}</td>
                      <td>${docLink}</td>
                      <td>${invLink}</td>
                    `;
                        tbody.appendChild(tr);
                    });
                } else {
                    histSec.style.display = "none";
                }
                document.getElementById("payAmount").value = "";
            }

            async function submitPayment() {
                const amt = document.getElementById("payAmount").value;
                const type = document.getElementById("payType").value;
                const date = document.getElementById("payDate").value;
                const fileInput = document.getElementById("payFile");

                if (!amt || Number(amt) <= 0) {
                    alert("Please enter a valid payment amount");
                    return;
                }
                if (!date) {
                    alert("Please select a date");
                    return;
                }

                if (!confirm("Add ₹" + amt + " (" + type + ") to order " + currentRefCode + "?")) return;

                showOverlay();

                // Handle File
                let fileObj = null;
                if (fileInput.files.length > 0) {
                    try {
                        fileObj = await readFileAsBase64(fileInput.files[0]);
                    } catch (e) {
                        hideOverlay();
                        alert("Error reading file: " + e.message);
                        return;
                    }
                }

                const payload = {
                    amount: amt,
                    type: type,
                    date: date,
                    remarks: document.getElementById("payRemarks").value,
                    file: fileObj
                };

                google.script.run
                    .withSuccessHandler(res => {
                        hideOverlay();
                        if (res.success) {
                            showPopup("success", res.message, res.pdfUrl);
                            // Refresh view
                            searchOrder();
                        } else {
                            showPopup("error", res.message);
                        }
                    })
                    .withFailureHandler(err => {
                        hideOverlay();
                        showPopup("error", err.message);
                    })
                    .addPaymentToOrder(currentRefCode, payload);
            }

            function readFileAsBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const result = e.target.result;
                        // remove data:image/png;base64, prefix for Apps Script usually
                        const base64 = result.split(',')[1];
                        resolve({
                            name: file.name,
                            mimeType: file.type,
                            data: base64
                        });
                    };
                    reader.onerror = err => reject(err);
                    reader.readAsDataURL(file);
                });
            }

            function setText(id, val) {
                document.getElementById(id).textContent = val || "";
            }

            function formatDate(iso) {
                if (!iso) return "";
                try {
                    const d = new Date(iso);
                    return d.toLocaleDateString("en-IN");
                } catch (e) { return iso; }
            }

        </script>

</body>

</html>