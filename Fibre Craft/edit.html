<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Add Sales Order</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" />

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <style>
        body {
            background-color: #f7f7f7;
            font-size: 14px;
        }

        .app-container {
            max-width: 100%;
            padding: 0;
            margin: 0;
        }

        /* Top header bar */
        .top-bar {
            background-color: #007bff;
            color: #fff;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .top-bar-title {
            font-weight: 600;
            font-size: 16px;
            text-transform: uppercase;
        }

        .top-bar-actions .btn,
        .top-bar-actions .input-group {
            margin-left: 6px;
        }

        /* Card / section styling */
        .section-card {
            background-color: #fff;
            border-radius: 3px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.15);
            padding: 12px 16px;
            margin: 10px 8px;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        label {
            margin-bottom: 2px;
            font-weight: 500;
        }

        .required {
            color: #e53935;
            margin-left: 2px;
        }

        .form-control,
        .custom-select {
            height: calc(1.8rem + 6px);
            font-size: 13px;
        }

        /* Customer details grid – 4 columns on large screens */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            grid-column-gap: 12px;
        }

        /* Other details – 3 columns */
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            grid-column-gap: 12px;
        }

        @media (max-width: 1200px) {
            .grid-4 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .grid-3 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {

            .grid-4,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }

        .col-span-4 {
            grid-column: span 4;
        }

        .col-span-3 {
            grid-column: span 3;
        }

        .grid-5 {
            display: grid;
            grid-template-columns: repeat(5, minmax(0, 1fr));
            grid-column-gap: 12px;
        }

        @media (max-width: 1200px) {
            .grid-5 {
                grid-template-columns: repeat(3, minmax(0, 1fr));
            }
        }

        @media (max-width: 768px) {
            .grid-5 {
                grid-template-columns: 1fr;
            }
        }

        /* Product table */
        .table-wrapper {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 3px;
        }

        .product-table {
            min-width: 1100px;
            margin-bottom: 0;
        }

        .product-table thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
            white-space: nowrap;
            font-size: 12px;
            padding: 6px;
        }

        .product-table tbody td {
            padding: 4px 6px;
            vertical-align: middle;
            font-size: 12px;
        }

        .product-table input {
            font-size: 12px;
        }

        .product-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .product-toolbar .left-group button {
            margin-right: 6px;
        }

        .product-toolbar .right-group button {
            margin-left: 4px;
        }

        .product-search-input {
            max-width: 280px;
        }

        /* Footer buttons */
        .footer-actions {
            padding: 10px 8px 16px 8px;
        }

        .footer-actions .btn {
            min-width: 90px;
            margin-right: 6px;
        }

        .btn-save {
            background-color: #28a745;
            color: #fff;
        }

        .btn-save-print {
            background-color: #007bff;
            color: #fff;
        }

        .btn-back {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-clear {
            background-color: #dc3545;
            color: #fff;
        }

        textarea.form-control {
            min-height: 60px;
        }

        /* Delivery section header style */
        .delivery-title {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 4px 0 4px 0;
            border-top: 1px solid #eee;
            padding-top: 6px;
        }

        .delivery-title-left {
            font-weight: 600;
            color: #d32f2f;
            font-size: 13px;
        }

        .result-row {
            padding: 7px 10px;
            margin-bottom: 6px;
            background: #ffffff;
            border-radius: 5px;
            border: 1px solid #e2e2e2;
            cursor: pointer;
            transition: 0.15s;
            font-size: 14px;
        }

        .result-row:hover {
            background: #e9f2ff;
            border-color: #b9d6ff;
        }

        /* Make checkbox column aligned nicely */
        .checkbox-col {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-top: 22px;
        }

        /* Bigger clickable area */
        .custom-checkbox-box {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
            cursor: pointer;
        }

        /* Bigger checkbox */
        .custom-big-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Better label spacing */
        .custom-checkbox-label {
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        /* overlay + popup */
        #overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            z-index: 999;
        }

        .overlay-inner {
            display: flex;
            align-items: center;
            gap: 10px;
            background: transparent;
        }

        .spinner {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.25);
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .popup-card {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 50%;
            transform: translateX(-50%);
            top: 22%;
            min-width: 260px;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }

        .popup-card.success {
            background: #0b8a3a;
        }

        .popup-card.error {
            background: #b30000;
        }

        .popup-icon {
            font-size: 34px;
            margin-bottom: 8px;
        }

        .desc-editor-box {
            background: #fff;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.2s ease-out;
        }

        .input-error {
            border: 1.8px solid #e63946 !important;
            background-color: #ffe8e8 !important;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-5px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- TOP BAR -->
        <div class="top-bar">
            <div class="top-bar-title">EDIT SALES ORDER</div>
            <div class="top-bar-actions d-flex align-items-center">
                <button type="button" class="btn btn-sm btn-light" title="Search">
                    <i class="fas fa-search"></i>
                </button>
                <button type="button" class="btn btn-sm btn-success ml-2" onclick="handleFinish()"
                    style="display:none;">Finish</button>
            </div>
        </div>

        <!-- SECTION 1: CUSTOMER DETAILS -->
        <div class="section-card">
            <div class="section-title">Customer Details</div>

            <!-- Row 1 -->
            <div class="grid-5 mb-2">

                <div class="form-group">
                    <label>Client Type<span class="required">*</span></label>
                    <select id="clientType" class="custom-select">
                        <option value="">Please Select</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>GST Type<span class="required">*</span></label>
                    <select id="gstType" class="custom-select">
                        <option value="">Please Select</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date<span class="required">*</span></label>
                    <input id="orderDate" type="date" class="form-control date-today">
                </div>

                <div class="form-group">
                    <label>FY<span class="required">*</span></label>
                    <select id="fy" class="custom-select">
                        <option value="">Please Select</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Mobile<span class="required">*</span></label>
                    <div class="input-group">
                        <input id="mobile" type="text" class="form-control" placeholder="Enter Mobile Number" />
                    </div>
                </div>

            </div>

            <!-- Row 2 -->
            <div class="grid-4 mb-2">
                <div class="form-group">
                    <label>Alternate Mobile No</label>
                    <input id="altMobile" type="text" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input id="email" type="email" class="form-control" />
                </div>

                <div class="form-group">
                    <label> Person Name<span class="required">*</span></label>
                    <input id="customerName" type="text" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Company Name<span class="required">*</span></label>
                    <input id="companyName" type="text" class="form-control" />
                </div>
            </div>

            <div class="grid-4 mb-2">
                <!-- Billing Address (3 Columns) -->
                <div class="form-group col-span-3">
                    <label>Billing Address<span class="required">*</span></label>
                    <input id="address" type="text" class="form-control" />
                </div>

                <!-- Checkbox (1 Column, Bigger and Clean) -->
                <div class="form-group col-span-1 checkbox-col">
                    <div class="custom-checkbox-box">
                        <input type="checkbox" id="deliverySameCheckbox" class="form-check-input custom-big-checkbox" />
                        <label for="deliverySameCheckbox" class="form-check-label custom-checkbox-label">
                            Same as Billing Address
                        </label>
                    </div>
                </div>
            </div>

            <!-- Row 3 -->
            <div class="grid-4 mb-1">
                <div class="form-group">
                    <label>GST No.</label>
                    <div class="input-group">
                        <input id="gstNumber" type="text" class="form-control" />
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <i class="fas fa-calendar-alt"></i>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="display:none">
                    <label>Closer Date</label>
                    <input id="closerDate" type="date" class="form-control date-today">
                </div>
            </div>

            <!-- DELIVERY DETAILS -->
            <div id="deliverySection" class="grid-4 mt-1">
                <!-- Row 1 -->
                <div class="form-group">
                    <label>Mobile<span class="required">*</span></label>
                    <div class="input-group">
                        <input id="delMobile" type="text" class="form-control" placeholder="Enter Mobile  Number" />
                    </div>
                </div>

                <div class="form-group">
                    <label>GST No.<span class="required">*</span></label>
                    <input id="delGstNumber" type="text" class="form-control" placeholder="GST No. Number" />
                </div>

                <div class="form-group">
                    <label>Company Name<span class="required">*</span></label>
                    <input id="delCompanyName" type="text" class="form-control" />
                </div>

                <div class="form-group">
                    <label>Contact Person<span class="required">*</span></label>
                    <input id="delContactPerson" type="text" class="form-control" />
                </div>

                <!-- Row 2 -->
                <div class="form-group col-span-2">
                    <label>Email<span class="required">*</span></label>
                    <input id="delEmail" type="email" class="form-control" />
                </div>

                <div class="form-group col-span-3">
                    <label>Delivery Address<span class="required">*</span></label>
                    <input id="delAddress" type="text" class="form-control" />
                </div>
            </div>

            <div class="grid-4 mb-2">
                <div class="form-group">
                    <label>Head*</label>
                    <select id="heads" class="custom-select" required>
                        <option value="">Please Select</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>User*</label>
                    <select id="user" class="custom-select" required>
                        <option value="">Please Select</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- SECTION 2: PRODUCT TABLE -->
        <div class="section-card">
            <div class="section-title">Products</div>

            <div class="product-toolbar">
                <div class="left-group">
                    <button class="btn btn-sm btn-outline-secondary" type="button">Product</button>
                </div>

                <div class="right-group d-flex align-items-center">
                    <input id="productSearch" type="text" class="form-control form-control-sm product-search-input"
                        placeholder="Search Product From Product Master" />

                    <button class="btn btn-sm btn-outline-secondary ml-1" type="button" title="View Product"
                        onclick="loadAllProducts()">
                        <i class="fas fa-eye"></i>
                    </button>

                    <button class="btn btn-sm btn-outline-danger ml-1" type="button" title="Delete Row"
                        onclick="deleteLastProductRow()">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            </div>

            <div class="table-wrapper">
                <table class="table table-bordered table-sm product-table" id="productTable">
                    <!-- SELECT -->
                    <th style="width:30px;" class="text-center">
                        <input type="checkbox" id="selectAllProducts" title="Select All">
                    </th>

                    <th style="width:40px;">S.No</th>
                    <th style="width:40px;">Image</th>
                    <th style="width:40px;">Product Code</th>
                    <th style="width:40px;">Product Name</th>
                    <th style="width:40px;">Description</th>
                    <th style="width:60px;">Size</th>
                    <th style="width:40px;">Colour</th>
                    <th style="width:50px;">HSN</th>
                    <th style="width:10px;">Total QTY</th>
                    <th style="width:5px;">Unit Value</th>
                    <th style="width:50px;">Stock</th>
                    <th style="width:40px;">Sub Total</th>
                    <th style="width:40px;">GST %</th>
                    <th style="width:40px;">GST</th>
                    <th style="width:30px;">Total Price</th>
                    </tr>
                    </thead>

                    <tbody id="productTableBody">
                    </tbody>

                    <tfoot>
                        <tr>
                            <!-- LEFT EMPTY SIDE -->
                            <td colspan="7"></td>

                            <!-- TOTAL BOXES -->
                            <td colspan="9">
                                <div style="display: flex; gap: 10px; justify-content: flex-end; padding: 2px 4px;">

                                    <!-- Total Without GST -->
                                    <div style="display:flex; flex-direction:column; min-width:100px;">
                                        <span class="font-weight">Total Without GST</span>
                                        <input id="totalWithoutGst" class="form-control form-control-sm" readonly>
                                    </div>

                                    <!-- Total CGST -->
                                    <div style="display:flex; flex-direction:column; min-width:100px;">
                                        <span class="font-weight">CGST</span>
                                        <input id="totalCgst" class="form-control form-control-sm" readonly>
                                    </div>

                                    <!-- Total SGST -->
                                    <div style="display:flex; flex-direction:column; min-width:100px;">
                                        <span class="font-weight">SGST</span>
                                        <input id="totalSgst" class="form-control form-control-sm" readonly>
                                    </div>

                                    <!-- IGST -->
                                    <div style="display:flex; flex-direction:column; min-width:100px;">
                                        <span class="font-weight">IGST</span>
                                        <input id="totalIgst" class="form-control form-control-sm" readonly>
                                    </div>

                                    <!-- Grand Total -->
                                    <div style="display:flex; flex-direction:column; min-width:100px;">
                                        <span class="font-weight-bold">Grand Total</span>
                                        <input id="grandTotalFooter" class="form-control form-control-sm" readonly>
                                    </div>

                                </div>
                            </td>
                        </tr>
                    </tfoot>
                </table>

                <div id="simpleSearchResults" style="
            display:none;
            margin-top:10px;
            max-height:180px;
            overflow-y:auto;
            padding:6px;
            border:1px solid #ccc;
            border-radius:6px;
            background:rgba(250,250,250,0.9);
            backdrop-filter: blur(3px);
          ">
                </div>

            </div>
        </div>

        <!-- SECTION 3: OTHER DETAILS -->
        <div class="section-card">
            <div class="section-title">Other Details</div>

            <div class="grid-3 mb-2">
                <!-- Only Total Amount remains (status & category removed) -->
                <div class="form-group">
                    <label>Total Amount</label>
                    <input id="grandTotal" type="number" class="form-control" value="0" readonly />
                </div>
                <div class="form-group">
                    <label>Advance Amount</label>
                    <input id="advanceAmount" type="number" class="form-control" placeholder="0" />
                </div>

                <div class="form-group">
                    <label>PO Number</label>
                    <input id="poNumber" type="text" class="form-control" />
                </div>
            </div>

            <div class="grid-3 mb-2">
                <div class="form-group">
                    <label>PO Date</label>
                    <input id="poDate" type="date" class="form-control date-today">
                </div>
                <div class="form-group">
                    <label>Customer Documents</label>
                    <input id="customerDocs" type="file" class="form-control-file" />
                    <input type="hidden" id="existingCustomerDocUrl" />
                    <div id="customerDocLink" style="font-size:12px; margin-top:4px;"></div>
                </div>
                <div class="form-group">
                    <label>Agreement Copy</label>
                    <input id="agreementCopy" type="file" class="form-control-file" />
                    <input type="hidden" id="existingAgreementCopyUrl" />
                    <div id="agreementCopyLink" style="font-size:12px; margin-top:4px;"></div>
                </div>
            </div>



            <div class="grid-3">
                <div class="form-group col-span-3">
                    <label>Remarks</label>
                    <textarea id="remarks" class="form-control" placeholder="Remarks"></textarea>
                </div>
            </div>
        </div>

        <!-- FOOTER BUTTONS -->
        <div class="footer-actions">
            <button type="button" class="btn btn-save" onclick="handleSave()">Save</button>
            <button type="button" class="btn btn-clear" onclick="handleClear()">Clear</button>
        </div>

        <!-- overlay + popup -->
        <div id="overlay" aria-hidden="true">
            <div class="overlay-inner" role="status" aria-live="polite">
                <div class="spinner" aria-hidden="true"></div>
                <div style="color:white; font-weight:600">Please wait...</div>
            </div>
        </div>

        <div id="popup-success" class="popup-card success" role="alert">
            <div class="popup-icon">✔</div>
            <div id="popup-success-text">Saved successfully</div>
            <div style="margin-top:12px;">
                <button class="btn" onclick="hidePopup()">Close</button>
            </div>
        </div>

        <div id="popup-error" class="popup-card error" role="alert">
            <div class="popup-icon">✖</div>
            <div id="popup-error-text">Error message</div>
            <div style="margin-top:12px;">
                <button class="btn" onclick="hidePopup()">Close</button>
            </div>
        </div>
    </div>



    <!-- JS: jQuery + Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        /* ====== CONFIG ====== */
        const EDIT_REF_CODE = "<?= referenceCode ?>";

        /* ====== GLOBALS ====== */
        let popupTimeout;
        let productRowCounter = 0;
        let allProductsCache = null;
        let currentDescriptionInput = null;

        // Promise to mark dropdowns readiness
        let _dropdownsReadyResolve;
        const dropdownsReady = new Promise((resolve) => { _dropdownsReadyResolve = resolve; });

        // Pending values to apply to selects after dropdowns are loaded
        const PENDING_SELECTS = {
            clientType: null,
            heads: null,
            user: null
        };

        /* ====== HELPERS ====== */
        function formatDateForInput(v) {
            if (v === null || v === undefined || v === "") return "";
            try {
                if (typeof v === "string") {
                    const isoMatch = v.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (isoMatch) return isoMatch[1];
                }
                if (Object.prototype.toString.call(v) === "[object Date]" || v instanceof Date) {
                    if (!isNaN(v.getTime())) return v.toISOString().split("T")[0];
                }
                const num = Number(v);
                if (!isNaN(num) && num !== 0) {
                    const d = new Date(num);
                    if (!isNaN(d.getTime())) return d.toISOString().split("T")[0];
                }
                const d2 = new Date(String(v));
                if (!isNaN(d2.getTime())) return d2.toISOString().split("T")[0];
            } catch (e) {
                console.warn("formatDateForInput parse error:", e, v);
            }
            return "";
        }
        function safeFormatDate(v) { return formatDateForInput(v); }

        function getValueFuzzy(dataObj, ...candidates) {
            if (!dataObj) return "";
            for (const k of candidates) {
                if (dataObj[k] !== undefined && dataObj[k] !== null) return dataObj[k];
            }
            const dataKeys = Object.keys(dataObj);
            for (const k of candidates) {
                const lower = k.toLowerCase();
                const foundKey = dataKeys.find(dk => dk.toLowerCase() === lower);
                if (foundKey && dataObj[foundKey] !== undefined) return dataObj[foundKey];
            }
            for (const k of candidates) {
                const clean = k.toLowerCase().replace(/[^a-z0-9]/g, "");
                const foundKey = dataKeys.find(dk => dk.toLowerCase().replace(/[^a-z0-9]/g, "") === clean);
                if (foundKey && dataObj[foundKey] !== undefined) return dataObj[foundKey];
            }
            return "";
        }

        /* ====== NORMALISATION / EXCLUSION (kept for compatibility) ====== */
        function normalizeHeaderToId(header) {
            if (!header) return "";
            const h = String(header).trim();
            const map = {
                "Timestamp": "",
                "RefCode": "refCode",
                "OrderDate": "orderDate",
                "FY": "fy",
                "GSTType": "gstType",
                "Mobile": "mobile",
                "AltMobile": "altMobile",
                "Email": "email",
                "CustomerName": "customerName",
                "CompanyName": "companyName",
                "BillingAddress": "address",
                "GSTNumber": "gstNumber",
                "Head": "heads",
                "User": "user",
                "DeliverySame": "deliverySameCheckbox",
                "DelMobile": "delMobile",
                "DelGST": "delGstNumber",
                "DelCompany": "delCompanyName",
                "DelPerson": "delContactPerson",
                "DelEmail": "delEmail",
                "DelAddress": "delAddress",
                "PONumber": "poNumber",
                "PODate": "poDate",
                "AdvanceAmount": "advanceAmount",
                "ClientType": "clientType",
                "PaymentTerms": "paymentTerms",
                "Remarks": "remarks",
                "Total Without GST": "totalWithoutGst",
                "Total CGST": "totalCgst",
                "Total SGST": "totalSgst",
                "Total IGST": "totalIgst",
                "Footer Grand Total": "grandTotalFooter",
                "GrandTotal": "grandTotal"
            };
            for (const k in map) {
                if (k.toLowerCase() === h.toLowerCase()) return map[k];
            }
            const safe = h.toLowerCase().replace(/[^a-z0-9]/g, "");
            if (safe === "billingaddress") return "address";
            if (safe === "gstnumber") return "gstNumber";
            if (safe === "companyname") return "companyName";
            if (safe === "customername") return "customerName";
            return safe;
        }

        const EXCLUDED_SINGLE_FIELDS = new Set([
            "Timestamp",
            "ProductCode", "ProductName", "Description", "Size", "Colour", "HSN", "Qty", "UnitValue", "Stock", "SubTotal", "GST%", "GSTAmount", "TotalPrice", "GrandTotal",
            "PONumber", "PODate", "AdvanceAmount", "ClientType", "PaymentTerms", "Remarks",
            "Total Without GST", "Total CGST", "Total SGST", "Total IGST", "Footer Grand Total",
            "Product Code", "Product Name", "GST %", "GSTPercent", "GST Percent", "Total Price", "Sub Total"
        ]);

        function isProductColumn(header) {
            if (!header) return false;
            const clean = String(header).toLowerCase().replace(/[^a-z0-9]/g, "");
            const productTokens = ["product", "productcode", "productname", "description", "size", "colour", "color", "hsn", "qty", "quantity", "unitvalue", "stock", "subtotal", "gst", "gstpercent", "gstamount", "totalprice"];
            return productTokens.some(tok => clean.includes(tok));
        }

        /* ====== PAGE INIT: ensure dropdowns load BEFORE we fetch reference ====== */
        document.addEventListener("DOMContentLoaded", async function () {
            initOverlayAndPopup();
            initDeliverySync();
            initProductSearchBehaviour();

            // Set default dates quickly
            setTimeout(() => {
                const today = new Date().toISOString().split("T")[0];
                document.querySelectorAll(".date-today").forEach(el => { if (!el.value) el.value = today; });
            }, 30);

            // Load dropdowns first and resolve the dropdownsReady promise
            try {
                await loadAllDropdowns();
                if (typeof _dropdownsReadyResolve === "function") _dropdownsReadyResolve();
            } catch (err) {
                console.error("Dropdown load failed", err);
                showPopup("error", "Failed to load form options");
                if (typeof _dropdownsReadyResolve === "function") _dropdownsReadyResolve(); // still resolve so page isn't blocked
            }

            // Now load order (guaranteed after dropdowns)
            if (EDIT_REF_CODE && EDIT_REF_CODE !== "") {
                await loadOrderForEdit(EDIT_REF_CODE);
            }
        });


        async function loadOrderForEdit(refCode) {
            // Ensure dropdowns are ready
            try { await dropdownsReady; } catch (e) { /* continue */ }

            showOverlay();
            try {
                // Use runGoogleScript helper - returns the same shape as google.script.run previously
                const rows = await runGoogleScript("getOrdersByRefCode", refCode);

                hideOverlay();

                if (!rows || (Array.isArray(rows) && rows.length === 0)) {
                    showPopup("error", "No record found for ref: " + refCode);
                    return null;
                }

                // If it's an object with header/items, use header for form and items to populate product rows
                let orderHeader = null;
                let orderItems = null;

                if (!Array.isArray(rows) && typeof rows === "object") {
                    // shape: { header, items, totals } OR { ...fields..., items: [...] }
                    orderHeader = rows.header || rows;
                    orderItems = rows.items || null;
                    // if orderHeader contains items as rows (rare), remove items property
                    if (orderHeader && orderHeader.items) delete orderHeader.items;
                } else if (Array.isArray(rows)) {
                    // If the server returned array:
                    // - If first element has 'items' property, prefer that
                    if (rows.length > 0 && rows[0] && rows[0].items) {
                        orderHeader = rows[0].header || rows[0];
                        orderItems = rows[0].items || null;
                    } else {
                        orderHeader = rows[0];
                        orderItems = rows; // each row in array represents a product row
                    }
                }

                // Fill main non-product form fields using the header object (this is your existing safe method)
                fillFormWithData(orderHeader || (Array.isArray(rows) ? rows[0] : rows));

                // Populate product table from the order items (if any)
                await populateProductsFromOrder(orderItems || rows);

                // final recalculation
                recalculateGrandTotal();

                return orderHeader || (Array.isArray(rows) ? rows[0] : rows);

            } catch (err) {
                hideOverlay();
                showPopup("error", (err && err.message) || "Backend crash");
                return null;
            }
        }

        /* ====== POPULATE PRODUCTS FROM ORDER (works with old & new response shapes) ====== */
        async function populateProductsFromOrder(orderItemsOrRows) {

            if (!orderItemsOrRows) return;

            // Normalize to array
            let rowsArray = Array.isArray(orderItemsOrRows) ? orderItemsOrRows : (orderItemsOrRows.items || []);
            if (!Array.isArray(rowsArray) || rowsArray.length === 0) return;

            // Ensure we have product master cached (fast path)
            if (!allProductsCache || !Array.isArray(allProductsCache) || allProductsCache.length === 0) {
                try {
                    allProductsCache = await runGoogleScript("getAllProducts");
                    if (!Array.isArray(allProductsCache)) allProductsCache = [];
                } catch (e) {
                    // if product master load fails, continue — we'll still try to populate from row data
                    allProductsCache = [];
                    console.warn("Failed to load product master:", e);
                }
            }

            // Clear current product rows so the order's items replace them
            const tbody = document.getElementById("productTableBody");
            if (!tbody) return;
            tbody.innerHTML = "";
            productRowCounter = 0;

            // Helper to extract fuzzy fields (we already have getValueFuzzy available globally)
            const pick = (obj, ...keys) => getValueFuzzy(obj, ...keys) || "";

            // For each product-row from sheet, construct an item and add a UI row
            for (const r of rowsArray) {
                // sometimes the server returns simple arrays of strings (unlikely) — mostly objects
                const productCode = String(pick(r, "ProductCode", "productCode", "Code", "code")).trim();
                let productObj = null;
                if (productCode && Array.isArray(allProductsCache)) {
                    productObj = allProductsCache.find(p => {
                        const pcode = String(p.code || p.productCode || "").trim();
                        return pcode !== "" && pcode === productCode;
                    });
                }

                // Build item object for fillProductRow (it expects properties like code, productName, image, price, hsn, size, color)
                const item = {
                    code: productCode || pick(r, "ProductCode", "productCode"),
                    productName: pick(r, "ProductName", "productName", "Product Name", "Product"),
                    description: pick(r, "Description", "description"),
                    size: pick(r, "Size", "size"),
                    color: pick(r, "Colour", "colour", "Color", "color"),
                    hsnCode: pick(r, "HSN", "hsn", "HSN Code"),
                    price: pick(r, "UnitValue", "unitValue", "Price", "price"),
                    closingStock: pick(r, "Stock", "stock", "Closing Stock"),
                    // prioritise product master image, else use whatever is present in order row (productImage/Image/UploadedImage)
                    image: (productObj && (productObj.image || productObj.productImage)) || pick(r, "productImage", "Image", "Image Link", "UploadedImage")
                };

                // Add an empty product row and fill basic product fields (image/name/code/desc/etc)
                addProductRow();
                const productRows = document.querySelectorAll('#productTableBody tr[data-type="product"]');
                const last = productRows[productRows.length - 1];
                fillProductRow(last, item);

                // Now set numeric fields (qty, unit, subTotal, gstPercent, gstAmount, totalPrice)
                const setIf = (selectorName, value) => {
                    const el = last.querySelector(`[name='${selectorName}']`);
                    if (!el) return;
                    // only set if value is not empty string
                    if (value === null || value === undefined) return;
                    el.value = (typeof value === "number") ? value : String(value);
                };

                // Qty / Unit / GST
                const qty = Number(pick(r, "Qty", "totalQty", "quantity")) || Number(pick(r, "Qty", "qty")) || 1;
                const unit = Number(pick(r, "UnitValue", "unitValue", "Price", "price", "unit")) || Number(item.price) || 0;
                const gstPercent = Number(pick(r, "GST%", "GSTPercent", "gstPercent", "gst")) || 0;
                const subTotal = Number(pick(r, "SubTotal", "subTotal")) || +(qty * unit).toFixed(2);
                const gstAmount = Number(pick(r, "GSTAmount", "gstAmount")) || +(subTotal * (gstPercent / 100)).toFixed(2);
                const totalPrice = Number(pick(r, "TotalPrice", "totalPrice", "Total Price")) || +(subTotal + gstAmount).toFixed(2);

                setIf("totalQty", qty);
                setIf("unitValue", unit);
                setIf("gstPercent", gstPercent);
                setIf("subTotal", subTotal.toFixed ? subTotal.toFixed(2) : String(subTotal));
                setIf("gstAmount", gstAmount.toFixed ? gstAmount.toFixed(2) : String(gstAmount));
                setIf("totalPrice", totalPrice.toFixed ? totalPrice.toFixed(2) : String(totalPrice));

                // fire recalculation for the row to ensure derived fields / formatting are consistent
                try {
                    recalculateRow(last.querySelector("[name='unitValue']"));
                } catch (err) {
                    // ignore, but attempt final recalc below
                }
            }

            // After adding all rows, renumber and recalc totals
            renumberProductRows();
            recalculateGrandTotal();
        }

        /* ====== FILL MAIN FORM (no product rows) ====== */
        function fillFormWithData(rowObj) {
            if (!rowObj || typeof rowObj !== "object") return;

            // explicit values first
            const explicit = {
                clientType: getValueFuzzy(rowObj, "ClientType", "clientType"),
                gstType: getValueFuzzy(rowObj, "GSTType", "gstType"),
                orderDate: safeFormatDate(getValueFuzzy(rowObj, "OrderDate", "orderDate")),
                fy: getValueFuzzy(rowObj, "FY", "fy"),
                mobile: getValueFuzzy(rowObj, "Mobile", "mobile"),
                altMobile: getValueFuzzy(rowObj, "AltMobile", "altMobile"),
                email: getValueFuzzy(rowObj, "Email", "email"),
                customerName: getValueFuzzy(rowObj, "CustomerName", "customerName"),
                companyName: getValueFuzzy(rowObj, "CompanyName", "companyName"),
                address: getValueFuzzy(rowObj, "BillingAddress", "Billing Address", "address"),
                gstNumber: getValueFuzzy(rowObj, "GSTNumber", "gstNumber"),
                heads: getValueFuzzy(rowObj, "Head", "heads"),
                user: getValueFuzzy(rowObj, "User", "user"),
                poNumber: getValueFuzzy(rowObj, "PONumber", "poNumber"),
                poDate: safeFormatDate(getValueFuzzy(rowObj, "PODate", "poDate")),
                advanceAmount: getValueFuzzy(rowObj, "AdvanceAmount", "advanceAmount"),
                remarks: (getValueFuzzy(rowObj, "Remarks", "remarks") || "") +
                    (getValueFuzzy(rowObj, "PaymentTerms", "paymentTerms") ?
                        "\n\nPayment Terms:\n" + getValueFuzzy(rowObj, "PaymentTerms", "paymentTerms") : ""),
                totalWithoutGst: getValueFuzzy(rowObj, "Total Without GST", "totalWithoutGst"),
                totalCgst: getValueFuzzy(rowObj, "Total CGST", "totalCgst"),
                totalSgst: getValueFuzzy(rowObj, "Total SGST", "totalSgst"),
                totalIgst: getValueFuzzy(rowObj, "Total IGST", "totalIgst"),
                footerGrandTotal: getValueFuzzy(rowObj, "Footer Grand Total", "footerGrandTotal"),
                grandTotal: getValueFuzzy(rowObj, "GrandTotal", "grandTotal")
            };

            // apply explicit non-select inputs immediately
            Object.keys(explicit).forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                const val = explicit[id];

                // For select fields we use pending logic to guarantee options exist.
                if (el.tagName === "SELECT") {
                    // store in pending — we'll apply after ensures select options present
                    if (id === "clientType") PENDING_SELECTS.clientType = val || "";
                    else if (id === "heads") PENDING_SELECTS.heads = val || "";
                    else { /* other selects like fy are safe to set now */ el.value = val || ""; }
                } else if (el.type === "date") {
                    el.value = safeFormatDate(val);
                } else {
                    el.value = (val === undefined || val === null) ? "" : String(val);
                }
            });

            // Generic mapping for other non-product fields
            Object.keys(rowObj).forEach(header => {
                if (EXCLUDED_SINGLE_FIELDS.has(header)) return;
                if (isProductColumn(header)) return;

                const id = normalizeHeaderToId(header);
                if (!id) return;

                const dom = document.getElementById(id);
                if (!dom) return;

                // special delivery checkbox handling
                if (id === "deliverySameCheckbox") {
                    try {
                        const raw = String(rowObj[header] || "").toLowerCase();
                        dom.checked = (raw === "yes" || raw === "true" || raw === "1");
                        const deliverySection = document.getElementById("deliverySection");
                        if (deliverySection) deliverySection.style.display = dom.checked ? "none" : "grid";
                    } catch (e) { }
                    return;
                }

                if (dom.tagName === "SELECT") {
                    // store selects into pending if they are clientType/heads/user
                    if (id === "clientType") PENDING_SELECTS.clientType = rowObj[header];
                    else if (id === "heads") PENDING_SELECTS.heads = rowObj[header];
                    else if (id === "user") PENDING_SELECTS.user = rowObj[header];
                    else dom.value = rowObj[header] || "";
                } else if (dom.type === "date") {
                    dom.value = safeFormatDate(rowObj[header]);
                } else {
                    dom.value = (rowObj[header] === null || rowObj[header] === undefined) ? "" : String(rowObj[header]);
                }
            });

            // File URLs
            const customerDoc = getValueFuzzy(rowObj, "UploadedDocURL", "customerDocUrl", "customerDoc");
            if (customerDoc) {
                const existing = document.getElementById("existingCustomerDocUrl");
                const div = document.getElementById("customerDocLink");
                if (existing) existing.value = customerDoc;
                if (div) div.innerHTML = `<a href="${customerDoc}" target="_blank">View Existing File</a>`;
            }
            const agreementDoc = getValueFuzzy(rowObj, "AgreementCopyURL", "agreementDocUrl", "agreementCopy");
            if (agreementDoc) {
                const existing = document.getElementById("existingAgreementCopyUrl");
                const div = document.getElementById("agreementCopyLink");
                if (existing) existing.value = agreementDoc;
                if (div) div.innerHTML = `<a href="${agreementDoc}" target="_blank">View Existing File</a>`;
            }

            // At this point, dropdowns should already be loaded (we waited earlier).
            // Apply pending selects now (ensures options exist).
            applyPendingSelects();
        }

        /* ====== APPLY PENDING SELECT VALUES (ensures options exist) ====== */
        function applyPendingSelects() {
            // clientType
            if (PENDING_SELECTS.clientType) {
                const el = document.getElementById("clientType");
                if (el) el.value = String(PENDING_SELECTS.clientType);
            }

            // heads -> must load users after head is set (dependent)
            if (PENDING_SELECTS.heads) {
                const headEl = document.getElementById("heads");
                if (headEl) {
                    headEl.value = String(PENDING_SELECTS.heads);
                    // load users for head and preselect user if present
                    loadUsersForHead(PENDING_SELECTS.heads, PENDING_SELECTS.user || "");
                }
            } else if (PENDING_SELECTS.user) {
                // If only user provided but head not provided, try set user directly (rare)
                const userEl = document.getElementById("user");
                if (userEl) {
                    setTimeout(() => { userEl.value = String(PENDING_SELECTS.user); }, 0);
                }
            }

            // clear pending after applying
            PENDING_SELECTS.clientType = null;
            PENDING_SELECTS.heads = null;
            PENDING_SELECTS.user = null;
        }

        /* ====== DROPDOWNS LOADING ====== */
        function runGoogleScript(funcName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject)[funcName](...args);
            });
        }

        async function loadAllDropdowns() {
            const [gstTypes, fyList, clientTypes, headsList] = await Promise.all([
                runGoogleScript("getGstType"),
                runGoogleScript("getFy"),
                runGoogleScript("getClientType"),
                runGoogleScript("getHeadsList")
            ]);
            populateDropdown("gstType", gstTypes);
            populateDropdown("fy", fyList);
            populateDropdown("clientType", clientTypes);
            populateDropdown("heads", headsList);
            attachHeadListener();
            return; // caller resolves dropdownsReady
        }

        function populateDropdown(elementId, list) {
            const dropdown = document.getElementById(elementId);
            if (!dropdown) return;
            dropdown.innerHTML = `<option value="">Please Select</option>`;
            if (!list || list.length === 0) return;
            list.forEach((item, index) => {
                const option = document.createElement("option");
                option.value = item;
                option.textContent = item;
                if (elementId === "fy" && index === 0) option.selected = true;
                dropdown.appendChild(option);
            });
        }

        function attachHeadListener() {
            const headDropdown = document.getElementById("heads");
            if (!headDropdown) return;
            headDropdown.addEventListener("change", function () {
                const selectedHead = this.value;
                loadUsersForHead(selectedHead);
            });
        }

        function loadUsersForHead(selectedHead, preselectedUser = null) {
            if (!selectedHead) {
                populateDropdown("user", []);
                return;
            }
            google.script.run
                .withSuccessHandler(function (usersList) {
                    populateDropdown("user", usersList);
                    if (preselectedUser) {
                        // use timeout to ensure DOM options have rendered
                        setTimeout(() => {
                            const userDropdown = document.getElementById("user");
                            if (userDropdown) userDropdown.value = preselectedUser;
                        }, 0);
                    }
                })
                .getUsersByHead(selectedHead);
        }

        /* ====== DELIVERY SYNC (unchanged) ====== */
        function initDeliverySync() {
            const cb = document.getElementById("deliverySameCheckbox");
            const deliverySection = document.getElementById("deliverySection");
            if (!cb || !deliverySection) return;

            const syncPairs = [
                { src: "mobile", dst: "delMobile" },
                { src: "gstNumber", dst: "delGstNumber" },
                { src: "companyName", dst: "delCompanyName" },
                { src: "email", dst: "delEmail" },
                { src: "address", dst: "delAddress" }
            ];

            function syncOnce() {
                if (!cb.checked) return;
                syncPairs.forEach(pair => {
                    const s = document.getElementById(pair.src);
                    const d = document.getElementById(pair.dst);
                    if (s && d) d.value = s.value;
                });
            }

            syncPairs.forEach(pair => {
                const s = document.getElementById(pair.src);
                if (s) {
                    s.addEventListener("input", syncOnce);
                    s.addEventListener("change", syncOnce);
                }
            });

            cb.addEventListener("change", function () {
                if (cb.checked) {
                    syncOnce();
                    deliverySection.style.display = "none";
                } else {
                    deliverySection.style.display = "grid";
                }
            });

            if (cb.checked) {
                syncOnce();
                deliverySection.style.display = "none";
            } else {
                deliverySection.style.display = "grid";
            }
        }

        /* ====== PRODUCT SEARCH / UI / CALCS — kept intact but NOT auto-populated from ref data ====== */
        /* (I left your functions mostly unchanged; they will not be triggered by the reference load) */

        function initProductSearchBehaviour() {
            const searchInput = document.getElementById("productSearch");
            if (!searchInput) return;
            searchInput.addEventListener("focus", function () {
                const val = this.value.trim();
                if (val === "") {
                    if (allProductsCache && allProductsCache.length) renderProductsList(allProductsCache);
                    else loadAllProducts();
                }
            });
            searchInput.addEventListener("input", function () {
                const query = this.value.trim().toLowerCase();
                if (!query) {
                    if (allProductsCache && allProductsCache.length) renderProductsList(allProductsCache);
                    else clearSimpleSearch();
                    return;
                }
                if (allProductsCache && allProductsCache.length) {
                    const filtered = allProductsCache.filter(p => {
                        const haystack = [
                            p.code, p.productName, p.size, p.color, p.hsnCode, p.productCategory, p.description
                        ].filter(Boolean).join(" ").toLowerCase();
                        return haystack.includes(query);
                    });
                    renderProductsList(filtered);
                    return;
                }
                if (query.length < 2) { clearSimpleSearch(); return; }
                google.script.run.withSuccessHandler(showSimpleResults).searchProductByName(query);
            });
        }
        function loadAllProducts() {
            showOverlay();
            google.script.run
                .withSuccessHandler(function (products) {
                    hideOverlay();
                    allProductsCache = products || [];
                    renderProductsList(allProductsCache);
                })
                .withFailureHandler(function (err) {
                    hideOverlay();
                    console.error(err);
                    showPopup("error", "Failed to load product list");
                })
                .getAllProducts();
        }
        function showSimpleResults(results) { allProductsCache = results || []; renderProductsList(results); }
        function renderProductsList(results) {
            const container = document.getElementById("simpleSearchResults"); if (!container) return;
            container.innerHTML = "";
            if (!results || results.length === 0) {
                container.innerHTML = `<div style="padding:4px;">No products found</div>`;
                container.style.display = "block"; return;
            }
            results.forEach(item => {
                const div = document.createElement("div");
                div.className = "result-row";
                div.style.cursor = "pointer";
                div.style.padding = "4px 6px";
                div.textContent =
                    `Code: ${item.code} | Product: ${item.productName} | Size: ${item.size} | Color: ${item.color} | Price: ${item.price} | Stock: ${item.closingStock} | HSN: ${item.hsnCode} | Category: ${item.productCategory} | Desc: ${item.description}`;
                div.addEventListener("click", () => {
                    // user clicked to add a product manually — normal behaviour
                    addProductToNewPlainRow(item);
                    const ps = document.getElementById("productSearch"); if (ps) ps.value = "";
                });
                container.appendChild(div);
            });
            container.style.display = "block";
        }
        function clearSimpleSearch() { const c = document.getElementById("simpleSearchResults"); if (!c) return; c.innerHTML = ""; c.style.display = "none"; }

        function addProductToNewPlainRow(item) {
            // This is only used when user explicitly selects a product from search.
            addProductRow();
            const rows = document.querySelectorAll('#productTableBody tr[data-type="product"]');
            const last = rows[rows.length - 1];
            if (last) fillProductRow(last, item);
        }
        function toDirectDriveImage(url) {
            if (!url) return "https://via.placeholder.com/50?text=No+Img";
            let fileId = "";
            const matchSlash = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (matchSlash && matchSlash[1]) fileId = matchSlash[1];
            else {
                const matchParam = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (matchParam && matchParam[1]) fileId = matchParam[1];
            }
            if (fileId) return "https://drive.google.com/thumbnail?id=" + fileId + "&sz=w1000";
            return url;
        }
        function fillProductRow(row, item) {
            if (!row || !item) return;
            const imgEl = row.querySelector("img[name='productImage']");
            if (imgEl) imgEl.src = toDirectDriveImage(item.image || item.productImage || "");
            const set = (name, v) => { const el = row.querySelector(`[name='${name}']`); if (el) el.value = v || ""; };
            set("productCode", item.code || item.productCode || "");
            set("productName", item.productName || "");
            set("description", item.description || "");
            set("size", item.size || "");
            set("colour", item.color || item.colour || "");
            set("hsn", item.hsnCode || item.hsn || "");
            set("stock", item.closingStock || item.stock || "");
            set("unitValue", item.price || item.unitValue || "");
            try { recalculateRow(row.querySelector("[name='unitValue']")); } catch (e) { }
        }

        /* CREATE ROW / INLINE EDITORS (left intact) */
        function createProductRow(index) {
            return `
    <tr class="product-row" data-type="product" data-row="${index}">

      <!-- ROW SELECT -->
      <td class="text-center align-middle">
        <input type="checkbox" class="row-selector">
      </td>

      <!-- S.NO -->
      <td class="text-center align-middle">${index}</td>

      <!-- IMAGE -->
      <td class="text-center">
        <img name="productImage"
             src=""
             style="width:45px; height:45px; object-fit:contain; border:1px solid #ccc;"
             alt="No Image"
             referrerpolicy="no-referrer">
      </td>

      <td><input type="text" class="form-control form-control-sm" name="productCode"></td>
      <td><input type="text" class="form-control form-control-sm" name="productName"></td>

      <td>
        <input type="text"
               class="form-control form-control-sm descriptionInput"
               name="description"
               readonly
               placeholder="Click to edit"
               onclick="openInlineDescriptionEditor(this)">
      </td>

      <td><input type="text" class="form-control form-control-sm" name="size"></td>
      <td><input type="text" class="form-control form-control-sm" name="colour"></td>
      <td><input type="text" class="form-control form-control-sm" name="hsn"></td>

      <td><input type="number" class="form-control form-control-sm qty" name="totalQty" value="1" oninput="recalculateRow(this)"></td>
      <td><input type="number" class="form-control form-control-sm unitValue" name="unitValue" value="" oninput="recalculateRow(this)"></td>
      <td><input type="number" class="form-control form-control-sm" name="stock"></td>
      <td><input type="number" class="form-control form-control-sm subTotal" name="subTotal" value="0" readonly></td>
      <td><input type="number" class="form-control form-control-sm gstPercent" name="gstPercent" value="0" oninput="recalculateRow(this)"></td>
      <td><input type="number" class="form-control form-control-sm gstAmount" name="gstAmount" value="0" readonly></td>
      <td><input type="number" class="form-control form-control-sm totalPrice" name="totalPrice" value="0" readonly></td>
    </tr>

    <!-- INLINE DESCRIPTION EDITOR -->
    <tr class="desc-editor-row" data-type="editor" style="display:none;">
      <td colspan="16">
        <div class="desc-editor-box">
          <label><strong>Edit Description</strong></label>
          <textarea class="form-control descEditorTextarea" rows="2"></textarea>
          <div class="text-right mt-2">
            <button class="btn btn-sm btn-secondary" onclick="closeInlineEditor(this)">Cancel</button>
            <button class="btn btn-sm btn-success" onclick="saveInlineDescription(this)">Save</button>
          </div>
        </div>
      </td>
    </tr>
  `;
        }

        function openInlineDescriptionEditor(inputEl) {
            closeAllInlineEditors();
            currentDescriptionInput = inputEl;
            const row = inputEl.closest("tr");
            const editorRow = row.nextElementSibling;
            if (!editorRow) return;
            editorRow.querySelector(".descEditorTextarea").value = inputEl.value || "";
            editorRow.style.display = "table-row";
        }
        function saveInlineDescription(btn) {
            const editorRow = btn.closest("tr");
            const text = editorRow.querySelector(".descEditorTextarea").value;
            if (currentDescriptionInput) currentDescriptionInput.value = text;
            editorRow.style.display = "none";
            currentDescriptionInput = null;
        }
        function closeInlineEditor(btn) {
            const editorRow = btn.closest("tr");
            editorRow.style.display = "none";
            currentDescriptionInput = null;
        }
        function closeAllInlineEditors() {
            document.querySelectorAll('#productTableBody tr[data-type="editor"]').forEach(row => row.style.display = "none");
        }

        function addProductRow() {
            productRowCounter++;
            const tbody = document.getElementById("productTableBody");
            if (!tbody) return;
            tbody.insertAdjacentHTML("beforeend", createProductRow(productRowCounter));
        }
        function deleteLastProductRow() {
            const tbody = document.getElementById("productTableBody");
            if (!tbody) return;

            const productRows = Array.from(
                tbody.querySelectorAll('tr[data-type="product"]')
            );

            const selectedRows = productRows.filter(row =>
                row.querySelector(".row-selector")?.checked
            );

            if (selectedRows.length === 0) {
                showPopup("error", "Please select at least one product to delete.");
                return;
            }

            // Close inline editors first (safety)
            closeAllInlineEditors();

            selectedRows.forEach(row => {
                const editorRow = row.nextElementSibling;
                if (editorRow && editorRow.dataset.type === "editor") {
                    editorRow.remove();
                }
                row.remove();
            });

            // Re-index rows safely
            renumberProductRows();

            recalculateGrandTotal();
        }

        function renumberProductRows() {
            let index = 1;
            document
                .querySelectorAll('#productTableBody tr[data-type="product"]')
                .forEach(row => {
                    row.dataset.row = index;
                    row.children[1].textContent = index; // S.No cell (after checkbox)
                    index++;
                });

            productRowCounter = index - 1;
        }

        document.addEventListener("change", function (e) {
            if (e.target.id === "selectAllProducts") {
                const checked = e.target.checked;
                document
                    .querySelectorAll(".row-selector")
                    .forEach(cb => cb.checked = checked);
            }
        });

        /* ====== CALCULATIONS ====== */
        function recalculateRow(el) {
            if (!el) return;
            const row = el.closest("tr");
            if (!row || row.dataset.type !== "product") return;
            const qty = parseFloat(row.querySelector(".qty").value) || 0;
            const unit = parseFloat(row.querySelector(".unitValue").value) || 0;
            const gstP = parseFloat(row.querySelector(".gstPercent").value) || 0;
            const sub = qty * unit;
            const gst = (sub * gstP) / 100;
            const total = sub + gst;
            row.querySelector(".subTotal").value = sub.toFixed(2);
            row.querySelector(".gstAmount").value = gst.toFixed(2);
            row.querySelector(".totalPrice").value = total.toFixed(2);
            recalculateGrandTotal();
        }
        function recalculateGrandTotal() {
            let totalWithoutGst = 0;
            let totalGst = 0;
            let grandTotal = 0;
            document.querySelectorAll('#productTableBody tr[data-type="product"]').forEach(row => {
                const sub = parseFloat(row.querySelector(".subTotal").value) || 0;
                const gst = parseFloat(row.querySelector(".gstAmount").value) || 0;
                const total = parseFloat(row.querySelector(".totalPrice").value) || 0;
                totalWithoutGst += sub;
                totalGst += gst;
                grandTotal += total;
            });
            const gstTypeVal = (document.getElementById("gstType")?.value || "").toLowerCase();
            let cgst = 0, sgst = 0, igst = 0;
            if (gstTypeVal.includes("local")) { cgst = totalGst / 2; sgst = totalGst / 2; igst = 0; }
            else if (gstTypeVal.includes("inter") || gstTypeVal.includes("inner") || gstTypeVal.includes("igst")) { cgst = 0; sgst = 0; igst = totalGst; }
            else { cgst = totalGst / 2; sgst = totalGst / 2; igst = 0; }
            const totalWithoutGstEl = document.getElementById("totalWithoutGst");
            const totalCgstEl = document.getElementById("totalCgst");
            const totalSgstEl = document.getElementById("totalSgst");
            const totalIgstEl = document.getElementById("totalIgst");
            const grandTotalFooter = document.getElementById("grandTotalFooter");
            const grandTotalBox = document.getElementById("grandTotal");
            if (totalWithoutGstEl) totalWithoutGstEl.value = totalWithoutGst.toFixed(2);
            if (totalCgstEl) totalCgstEl.value = cgst.toFixed(2);
            if (totalSgstEl) totalSgstEl.value = sgst.toFixed(2);
            if (totalIgstEl) totalIgstEl.value = igst.toFixed(2);
            if (grandTotalFooter) grandTotalFooter.value = grandTotal.toFixed(2);
            if (grandTotalBox) grandTotalBox.value = grandTotal.toFixed(2);
        }

        /* ====== VALIDATION, COLLECT, FILES, SUBMIT (kept intact) ====== */
        function validateMandatoryFields() {
            const mandatoryFields = ["clientType", "gstType", "gstNumber", "heads", "user", "mobile", "customerName", "companyName", "email"];
            let allGood = true;
            mandatoryFields.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.classList.remove("input-error");
                const value = el.value?.trim() || "";
                if (value === "") { allGood = false; el.classList.add("input-error"); }
            });
            if (!allGood) showPopup("error", "Please fill all mandatory fields.");
            return allGood;
        }

        function collectFormData() {
            const get = id => document.getElementById(id)?.value || "";
            const getChecked = id => document.getElementById(id)?.checked || false;
            const data = {};
            const formRef = get("refCode");
            const fallbackRef = (typeof EDIT_REF_CODE !== "undefined" && EDIT_REF_CODE !== null) ? String(EDIT_REF_CODE) : "";
            data.refCode = (formRef && String(formRef).trim()) ? String(formRef).trim() : (String(fallbackRef).trim() || "");
            data.gstType = get("gstType");
            data.orderDate = get("orderDate");
            data.fy = get("fy");
            data.mobile = get("mobile");
            data.altMobile = get("altMobile");
            data.email = get("email");
            data.customerName = get("customerName");
            data.companyName = get("companyName");
            data.address = get("address");
            data.gstNumber = get("gstNumber");
            data.heads = get("heads");
            data.user = get("user");
            data.deliverySameAsOrder = getChecked("deliverySameCheckbox");
            data.delMobile = get("delMobile");
            data.delGstNumber = get("delGstNumber");
            data.delCompanyName = get("delCompanyName");
            data.delContactPerson = get("delContactPerson");
            data.delEmail = get("delEmail");
            data.delAddress = get("delAddress");

            // Collect product rows (these will be only ones user has added manually)
            const products = [];
            document.querySelectorAll('#productTableBody tr[data-type="product"]').forEach(row => {
                const getCell = name => row.querySelector(`[name="${name}"]`)?.value || "";
                const getImg = () => row.querySelector("img[name='productImage']")?.src || "";
                products.push({
                    productCode: getCell("productCode"),
                    productName: getCell("productName"),
                    description: getCell("description"),
                    size: getCell("size"),
                    colour: getCell("colour"),
                    hsn: getCell("hsn"),
                    totalQty: getCell("totalQty"),
                    unitValue: getCell("unitValue"),
                    stock: getCell("stock"),
                    subTotal: getCell("subTotal"),
                    gstPercent: getCell("gstPercent"),
                    gstAmount: getCell("gstAmount"),
                    totalPrice: getCell("totalPrice"),
                    productImage: getImg()
                });
            });
            data.products = products;

            data.totalWithoutGst = get("totalWithoutGst");
            data.totalCgst = get("totalCgst");
            data.totalSgst = get("totalSgst");
            data.totalIgst = get("totalIgst");
            data.footerGrandTotal = get("grandTotalFooter") || get("grandTotal");
            data.grandTotal = get("grandTotal");
            data.poNumber = get("poNumber");
            const poDate = get("poDate");
            data.poDate = data.poNumber.trim() !== "" ? poDate : "";
            data.advanceAmount = get("advanceAmount");
            data.clientType = get("clientType");

            data.remarks = get("remarks");
            data.existingCustomerDocUrl = get("existingCustomerDocUrl");
            data.existingAgreementCopyUrl = get("existingAgreementCopyUrl");
            return data;
        }

        function collectFilesBase64() {
            const mapping = [{ id: "customerDocs", field: "customerDocs" }, { id: "agreementCopy", field: "agreementCopy" }];
            const promises = [];
            mapping.forEach(info => {
                const input = document.getElementById(info.id);
                if (input && input.files && input.files.length > 0) {
                    const file = input.files[0];
                    promises.push(readFileAsBase64(file).then(base64 => ({
                        fieldName: info.field, fileName: file.name, mimeType: file.type, data: base64
                    })));
                }
            });
            return Promise.all(promises);
        }
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const arrBuff = e.target.result;
                        let binary = "";
                        const bytes = new Uint8Array(arrBuff);
                        const len = bytes.byteLength;
                        for (let i = 0; i < len; i++) binary += String.fromCharCode(bytes[i]);
                        resolve(btoa(binary));
                    } catch (err) { reject(err); }
                };
                reader.onerror = function (err) { reject(err); };
                reader.readAsArrayBuffer(file);
            });
        }

        async function submitOrder(options) {
            const opts = options || {};
            let payload = collectFormData();
            if (payload.deliverySameAsOrder) {
                payload.delMobile = payload.mobile || "";
                payload.delGstNumber = payload.gstNumber || "";
                payload.delCompanyName = payload.companyName || "";
                payload.delContactPerson = payload.customerName || "";
                payload.delEmail = payload.email || "";
                payload.delAddress = payload.address || "";
            }
            showOverlay();
            try {
                const files = await collectFilesBase64();
                google.script.run
                    .withSuccessHandler(function (res) {
                        hideOverlay();
                        if (res && res.success) {
                            const msg = res.message || (opts.print ? "Order saved and ready for print." : "Sales order saved successfully.");
                            showPopup("success", msg);
                            if (opts.print) {
                                if (res.printUrl) window.open(res.printUrl, "_blank"); else window.print();
                            }
                            if (res.invoiceUrl) window.open(res.invoiceUrl, "_blank");
                            resetFormAfterSubmit();
                        } else {
                            showPopup("error", (res && res.message) || "Failed to save sales order.");
                        }
                    })
                    .withFailureHandler(function (err) {
                        hideOverlay();
                        showPopup("error", (err && err.message) || "Unexpected error.");
                    })
                    .updateSalesOrderWithFiles(payload, files, opts);
            } catch (err) {
                hideOverlay();
                showPopup("error", err.message || "Error while reading files.");
            }
        }

        /* ====== FOOTER HANDLERS & RESET ====== */
        function handleSave() { if (!validateMandatoryFields()) return; submitOrder({ print: false }); }
        function handleSaveAndPrint() { submitOrder({ print: true }); }
        function handleClear() { resetFormAfterSubmit(); }
        function handleBack() { history.back(); }
        function handleFinish() { handleSaveAndPrint(); }

        function resetFormAfterSubmit() {
            document.querySelectorAll("input, select, textarea").forEach(el => {
                if (el.type === "checkbox" || el.type === "radio") {
                    if (el.id === "deliverySameCheckbox") el.checked = true; else el.checked = false;
                } else if (el.tagName === "SELECT" && el.id === "fy") return;
                else if (el.tagName === "SELECT") el.selectedIndex = 0;
                else if (el.type === "file") el.value = "";
                else if (el.type === "date") return;
                else {
                    el.value = "";
                }
            });
            const deliverySection = document.getElementById("deliverySection");
            const cb = document.getElementById("deliverySameCheckbox");
            if (cb && deliverySection) deliverySection.style.display = cb.checked ? "none" : "grid";
            const tbody = document.getElementById("productTableBody");
            if (tbody) tbody.innerHTML = "";
            productRowCounter = 0;
            const totalWithoutGstEl = document.getElementById("totalWithoutGst");
            const totalCgstEl = document.getElementById("totalCgst");
            const totalSgstEl = document.getElementById("totalSgst");
            const totalIgstEl = document.getElementById("totalIgst");
            const grandTotalFooter = document.getElementById("grandTotalFooter");
            const grandTotalBox = document.getElementById("grandTotal");
            const searchInput = document.getElementById("productSearch");
            if (totalWithoutGstEl) totalWithoutGstEl.value = "0.00";
            if (totalCgstEl) totalCgstEl.value = "0.00";
            if (totalSgstEl) totalSgstEl.value = "0.00";
            if (totalIgstEl) totalIgstEl.value = "0.00";
            if (grandTotalFooter) grandTotalFooter.value = "0.00";
            if (grandTotalBox) grandTotalBox.value = "0.00";
            clearSimpleSearch();
            if (searchInput) searchInput.value = "";
        }

        /* ====== OVERLAY / POPUP UTILS ====== */
        function initOverlayAndPopup() {
            const overlay = document.getElementById("overlay");
            if (overlay) overlay.style.display = "none";
            hidePopup();
        }
        function showOverlay() { const overlay = document.getElementById("overlay"); if (overlay) overlay.style.display = "flex"; }
        function hideOverlay() { const overlay = document.getElementById("overlay"); if (overlay) overlay.style.display = "none"; }
        function showPopup(type, message) {
            hidePopup();
            const isError = type === "error";
            const popupId = isError ? "popup-error" : "popup-success";
            const textId = isError ? "popup-error-text" : "popup-success-text";
            const popupEl = document.getElementById(popupId);
            const textEl = document.getElementById(textId);
            if (!popupEl || !textEl) return;
            textEl.textContent = message || (isError ? "Something went wrong" : "Saved successfully");
            popupEl.style.display = "block";
            if (popupTimeout) clearTimeout(popupTimeout);
            popupTimeout = setTimeout(hidePopup, 3000);
        }
        function hidePopup() {
            if (popupTimeout) { clearTimeout(popupTimeout); popupTimeout = null; }
            const s = document.getElementById("popup-success");
            const e = document.getElementById("popup-error");
            if (s) s.style.display = "none";
            if (e) e.style.display = "none";
        }

        /* ====== CLICK-OUTSIDE SIMPLE SEARCH ====== */
        document.addEventListener("click", function (e) {
            const box = document.getElementById("simpleSearchResults");
            const searchInput = document.getElementById("productSearch");
            if (!box) return;
            if (searchInput && searchInput.contains(e.target)) return;
            if (box.contains(e.target)) return;
            box.style.display = "none";
        });
    </script>


</body>

</html>